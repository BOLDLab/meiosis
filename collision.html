<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.rawgit.com/konvajs/konva/1.3.0/konva.min.js"></script>
    <meta charset="utf-8">
    <title>Konva Drop Events Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
            width: 540px;
            height: 845px;
        }
    </style>
</head>
<body>
<div id="container"></div>
<script>
    var width = window.innerWidth;
    var height = window.innerHeight;
    var circleDiameter = 70;
    var circleSpace = 80;
    var circleFillColor = 'rgba(254,255,173,0.8)';
    var circleDropColor = 'rgba(227,140,70, 0.8)';
    var circleHoverColor = 'rgba(174,197,217, 0.8)';
    var circleStrokeColor = 'black';
    var problemPosFormula = 'stage.width() - (circleDiameter * 2)';
    var cctXPos = 'circleDiameter';
    var cctYPos = 'circleDiameter';
    var containerFill = 'rgba(197,197,197,0.8)';
    var containerStroke = 'black';
    var iconWidth = 35;
    var iconHeight = 30;

    var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
    });

    var stageCenter = stage.width() / 2;

    var layer = new Konva.Layer();
    //var iconLayer = new Konva.Layer();
  //  stage.add(layer);

    var tempLayer = new Konva.Layer();
    stage.add(tempLayer);

    var text = new Konva.Text({
        fill : 'black'
    });
    layer.add(text);

    // setup egg interface
    var yoff = 0;
    var dropCircle;
    var opacity;
    var eggMap = [];
    for (var i = 0; i < 18; i++) {
        var x;
        var y;

        if(i < 4) {
           x = eval(problemPosFormula) - (circleDiameter / 2);
           y = circleDiameter + yoff;
           yoff += circleSpace;
        } else if(i < 14 && i % 2 == 1) {
           x = eval(problemPosFormula)  - circleDiameter * 1.5;
        } else if(i < 14 && i % 2 == 0) {
          x = eval(problemPosFormula) + circleDiameter / 2;
          y = circleDiameter + yoff;
          yoff += circleSpace;
        } else if(i == 14) {
          x = eval(problemPosFormula) - circleDiameter * 2.5;
          y = circleDiameter + yoff;
        } else if(i == 15) {
          x = eval(problemPosFormula)  - circleDiameter * 1.2;
        } else if(i == 16) {
          x = eval(problemPosFormula);
        } else if(i == 17) {
          x = eval(problemPosFormula) + circleDiameter * 1.3;
        }

        opacity = i > 0 ? 0.4 : 1.0;

        dropCircle = new Konva.Circle({
            x : x,
            y : y,
            fill : circleFillColor,
            radius: (circleDiameter / 2),
            stroke: circleStrokeColor,
            name : 'egg ' + i,
            opacity: opacity
        });

        layer.add(dropCircle);
        eggMap[i] = {egg: dropCircle, chromos: []};
    }

    // setup chromosome container
    var chromosomeContainer = new Konva.Rect({
          x: eval(cctXPos),
          y: eval(cctYPos),
          width: 190,
          height: 500,
          fill: containerFill,
          stroke: containerStroke,
          strokeWidth: 1,
          name: 'container',
        //  draggable: true
    });

    layer.add(chromosomeContainer);

    var chromos = new Image(), icon, iconPos = [];
    var xchromPos = eval(cctXPos) + 15;
    var ychromPos = eval(cctYPos) + 15;

      chromos.onload = function() {
          for(var i = 0; i < 4; i++) {
            icon = new Konva.Image({
                  x: xchromPos,
                  y: ychromPos,
                  image: chromos,
                  width: iconWidth,
                  height: iconHeight,
                  name: 'precursor_'+i,
                  draggable: true,
                  fill: 'transparent'
            });

            layer.add(icon);
            stage.add(layer);

            iconPos[i] = {x: xchromPos, y: ychromPos};
            xchromPos += 22;
          }
        };

    chromos.src = '/img/x-35.png';

    layer.draw();
    var currentDragee;
    stage.on("dragstart", function(e){
        e.target.moveTo(tempLayer);
        currentDragee = e.target;
        text.text('Moving ' + e.target.name());
        layer.draw();
    });

    var previousShape;
    stage.on("dragmove", function(evt){
        var pos = stage.getPointerPosition();
        var shape = layer.getIntersection(pos);
        if (previousShape && shape) {
            if (previousShape !== shape) {
                // leave from old targer
                previousShape.fire('dragleave', {
                    type : 'dragleave',
                    target : previousShape,
                    evt : evt.evt
                }, true);

                // enter new targer
                shape.fire('dragenter', {
                    type : 'dragenter',
                    target : shape,
                    evt : evt.evt
                }, true);
                previousShape = shape;
            } else {
                previousShape.fire('dragover', {
                    type : 'dragover',
                    target : previousShape,
                    evt : evt.evt
                }, true);
            }
        } else if (!previousShape && shape) {
            previousShape = shape;
            shape.fire('dragenter', {
                type : 'dragenter',
                target : shape,
                evt : evt.evt
            }, true);
        } else if (previousShape && !shape) {
            previousShape.fire('dragleave', {
                type : 'dragleave',
                target : previousShape,
                evt : evt.evt
            }, true);
         previousShape = undefined;
        }
    });
    stage.on("dragend", function(e){
        var pos = stage.getPointerPosition();
        var shape = layer.getIntersection(pos);

        if(shape) {
          if(shape.opacity() === 1.0) {
            if(shape instanceof Konva.Circle || (shape && shape.inEgg && shape.name() !== 'container')) {

                  previousShape.fire('drop', {
                      type : 'drop',
                      target : previousShape,
                      evt : e.evt
                  }, true);

              previousShape = undefined;
              e.target.moveTo(layer);
              layer.draw();
              tempLayer.draw();
              return;
          }
      }
    }

      returnToContainer(e.target);
    });

    stage.on("dragenter", function(e){
        if(e.target.opacity !== 1.0) return false;

        if(e.target instanceof Konva.Circle) {
          e.target.fill(circleHoverColor);
          text.text('dragenter ' + e.target.name());
          layer.draw();
      }
    });

    stage.on("dragleave", function(e){
      if(e.target.opacity !== 1.0) return false;

      if(e.target instanceof Konva.Circle) {
        e.target.fill(circleFillColor);
        text.text('dragleave ' + e.target.name());
        layer.draw();
      }
    });

    stage.on("dragover", function(e){
      if(e.target.opacity !== 1.0) return false;

      if(e.target instanceof Konva.Circle) {
        text.text('dragover ' + e.target.name());
        layer.draw();
      }
    });

    stage.on("drop", function(e){

      if(e.target.opacity() !== 1.0) {
          returnToContainer(currentDragee);
          return;
      }

      if(e.target instanceof Konva.Circle) {
            e.target.fill(circleDropColor);
            text.text('drop ' + e.target.name());
            layer.draw();

            placeInEgg(e.target);
      }
    });

    var placeInEgg = function(egg) {
        currentDragee.inEgg = egg;

        var w = currentDragee.getWidth();
        var h = currentDragee.getHeight();

        if(w === iconWidth) {
           w = w / 2;
        }
        if(h === iconHeight) {
           h = h / 2;
        }

        currentDragee.setWidth(w);
        currentDragee.setHeight(h);

        eggMap[egg.index - 1].chromos.push(currentDragee);

        if(eggMap[egg.index]) {
            eggMap[egg.index].egg.setOpacity(1.0);
        }

        console.log(eggMap);
    }

    var eggIsEmpty = function(egg) {
        // finish
    }

    var returnToContainer = function(icon) {


      if(icon.getWidth() < iconWidth) {
          icon.setWidth(iconWidth);
      }

      if(icon.getHeight() < iconHeight) {
          icon.setHeight(iconHeight);
      }

      icon.moveTo(layer);

      var index = Number(icon.name().split('_')[1]);

      icon.setX(iconPos[index].x);
      icon.setY(iconPos[index].y);

      layer.draw();
      tempLayer.draw();

      eggMap[icon.inEgg.index-1].chromos.remove(currentDragee);

      console.log(eggMap);
      
      icon.inEgg = null;
    }

    Array.prototype.remove = function (v) {
      if (this.indexOf(v) != -1) {
          this.splice(this.indexOf(v), 1);
          return true;
      }
    return false;
}
</script>

</body>
</html>
